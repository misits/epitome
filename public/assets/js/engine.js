var I={format:(t,e={},n="en-US")=>{let i=t instanceof Date?t:new Date(t);return new Intl.DateTimeFormat(n,e).format(i)},toYMD:t=>(t instanceof Date?t:new Date(t)).toISOString().split("T")[0],getRelativeTime:(t,e="en-US")=>{let n=t instanceof Date?t:new Date(t),i=new Intl.RelativeTimeFormat(e,{numeric:"auto"}),r=Math.floor((new Date().getTime()-n.getTime())/1e3);if(r<60)return i.format(-r,"second");let s=Math.floor(r/60);if(s<60)return i.format(-s,"minute");let a=Math.floor(s/60);if(a<24)return i.format(-a,"hour");let l=Math.floor(a/24);if(l<30)return i.format(-l,"day");let c=Math.floor(l/30);if(c<12)return i.format(-c,"month");let d=Math.floor(c/12);return i.format(-d,"year")}};var k=(t,e=300,n=!1)=>{let i=null;return function(...o){let r=this,s=()=>{i=null,n||t.apply(r,o)},a=n&&!i;i&&clearTimeout(i),i=setTimeout(s,e),a&&t.apply(r,o)}},D=(t,e=300)=>{let n=!1,i=null,o=0;return function(...r){let s=this;n?(i&&clearTimeout(i),i=setTimeout(()=>{Date.now()-o>=e&&(t.apply(s,r),o=Date.now())},e-(Date.now()-o))):(t.apply(s,r),o=Date.now(),n=!0)}},O=t=>new Promise(e=>setTimeout(e,t));var g={set:(t,e)=>{try{localStorage.setItem(t,JSON.stringify(e))}catch(n){console.error("Error saving to localStorage:",n)}},get:(t,e=null)=>{try{let n=localStorage.getItem(t);return n?JSON.parse(n):e}catch(n){return console.error("Error reading from localStorage:",n),e}},remove:t=>{try{localStorage.removeItem(t)}catch(e){console.error("Error removing from localStorage:",e)}},clear:()=>{try{localStorage.clear()}catch(t){console.error("Error clearing localStorage:",t)}}};var P={getParams:(t=window.location.href)=>{let e={},n=document.createElement("a");n.href=t;let o=n.search.substring(1).split("&");for(let r=0;r<o.length;r++){if(o[r]==="")continue;let s=o[r].split("=");e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]||"")}return e},buildUrl:(t,e={})=>{let n=new URL(t);return Object.keys(e).forEach(i=>{n.searchParams.append(i,e[i])}),n.toString()}};var p={qs:(t,e=document)=>{try{return e.querySelector(t)}catch(n){return console.error(`Invalid selector: ${t}`,n),null}},qsa:(t,e=document)=>{try{return Array.from(e.querySelectorAll(t))}catch(n){return console.error(`Invalid selector: ${t}`,n),[]}},on:(t,e,n,i={})=>t?(t.addEventListener(e,n,i),()=>{t.removeEventListener(e,n,i)}):()=>{}};var R={truncate:(t,e=100,n="...")=>!t||t.length<=e?t:t.substring(0,e-n.length)+n,capitalize:t=>t?t.charAt(0).toUpperCase()+t.slice(1):"",toCamelCase:t=>t.replace(/(?:^\w|[A-Z]|\b\w)/g,(e,n)=>n===0?e.toLowerCase():e.toUpperCase()).replace(/\s+/g,""),toKebabCase:t=>t.match(/[A-Z]{2,}(?=[A-Z][a-z]+[0-9]*|\b)|[A-Z]?[a-z]+[0-9]*|[A-Z]|[0-9]+/g)?.map(e=>e.toLowerCase()).join("-")||""};var F={chunk:(t,e=1)=>{let n=[];for(let i=0;i<t.length;i+=e)n.push(t.slice(i,i+e));return n},shuffle:t=>{let e=[...t],n=e.length,i,o;for(;n!==0;)o=Math.floor(Math.random()*n),n-=1,i=e[n],e[n]=e[o],e[o]=i;return e},randomItem:t=>t[Math.floor(Math.random()*t.length)],unique:t=>[...new Set(t)]};var T={get:t=>{let e=document.cookie.match(new RegExp(`(^|;\\s*)(${t})=([^;]*)`));return e?decodeURIComponent(e[3]):null},set:(t,e,n={})=>{let i={path:"/",...n};i.expires instanceof Date&&(i.expires=i.expires.toUTCString());let o=`${encodeURIComponent(t)}=${encodeURIComponent(e)}`;for(let r in i){o+=`;${r}`;let s=i[r];s!==!0&&(o+=`=${s}`)}document.cookie=o},delete:(t,e={})=>{T.set(t,"",{...e,"max-age":-1})}};var S={deepClone:t=>JSON.parse(JSON.stringify(t)),deepMerge:(t,...e)=>{if(!e.length)return t;let n=e.shift();if(n===void 0)return t;if(typeof t=="object"&&typeof n=="object")for(let i in n)n[i]instanceof Object&&i in t?S.deepMerge(t[i],n[i]):Object.assign(t,{[i]:n[i]});return S.deepMerge(t,...e)},pick:(t,e)=>e.reduce((n,i)=>(i in t&&(n[i]=t[i]),n),{}),omit:(t,e)=>{let n={};for(let i in t)e.includes(i)||(n[i]=t[i]);return n}};var N={formatCurrency:(t,e="USD",n="en-US")=>new Intl.NumberFormat(n,{style:"currency",currency:e}).format(t),clamp:(t,e,n)=>Math.min(Math.max(t,e),n),random:(t,e,n=!0)=>{let i=Math.random()*(e-t)+t;return n?Math.floor(i):i},round:(t,e=0)=>{let n=Math.pow(10,e);return Math.round(t*n)/n}};var j={isEmail:t=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t),isURL:t=>{try{return new URL(t),!0}catch{return!1}},isPhoneNumber:t=>/^\+?[\d\s()-]{10,}$/.test(t),isStrongPassword:t=>/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\da-zA-Z]).{8,}$/.test(t)};var y=(t,e={})=>{let{timeout:n=8e3,...i}=e;return Promise.race([fetch(t,i),new Promise((o,r)=>setTimeout(()=>r(new Error("Request timeout")),n))]).then(async o=>{if(!o.ok){let r=new Error(`HTTP error! status: ${o.status}`);r.status=o.status;try{r.data=await o.json()}catch{r.data=await o.text()}throw r}return o})};var $=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{let e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)}),H=t=>{if(navigator.clipboard)return navigator.clipboard.writeText(t);{let e=document.createElement("textarea");e.value=t,e.style.position="fixed",document.body.appendChild(e),e.focus(),e.select();try{return document.execCommand("copy"),document.body.removeChild(e),Promise.resolve()}catch(n){return document.body.removeChild(e),Promise.reject(n)}}};var v=t=>!(!t||typeof t!="object"||!t.id||t.html===void 0),b=(t,e=100)=>{if(!t||t==="")return"";try{let n=document.createElement("div");n.innerHTML=t;let i=n.textContent||n.innerText||"";return i=i.replace(/\s+/g," ").trim(),i.length>e?i.substring(0,e)+"...":i}catch(n){return console.error("Error extracting summary:",n),""}},E=t=>t?t.toLowerCase().replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim():"",x=t=>{if(!t||typeof t!="object")return[];let e=Object.keys(t),n=new Set;return e.forEach(i=>{let o=t[i];o.next&&Array.isArray(o.next)&&o.next.forEach(r=>{r.id&&n.add(r.id)})}),e.filter(i=>i!=="index"&&!n.has(i))},q=t=>t?"condition"in t?!0:t.next&&Array.isArray(t.next)?t.next.some(e=>!!e.condition):!1:!1,W=(t,e="",n="",i=[])=>({id:t||E(e),title:e,html:n,next:i}),z=(t,e)=>t?e?{...t,...e,next:e.next||t.next}:t:e,_=(t,e)=>!t||!t.next||!Array.isArray(t.next)?!1:t.next.some(n=>{if(!n.condition)return!0;try{let o={flags:e,hasFlag:s=>e.has(s)};return new Function(...Object.keys(o),`return ${n.condition};`)(...Object.values(o))}catch(i){return console.error(`Error evaluating condition "${n.condition}":`,i),!1}}),K=(t,e)=>!t||!e?[]:Object.keys(t).filter(n=>{let i=t[n];return!i.next||!Array.isArray(i.next)?!1:i.next.some(o=>o.id===e)});var f,u,C,w,M,A;function L(t){f=t.domUtils,u=t.storage,C=t.fetchWithTimeout,w=t.validateScene,M=t.extractSummary,A=t.findOrphanedScenes}var h=class{constructor(e={}){this.container=null;this.scenes=null;this.lastChoice=null;this.options={containerId:e.containerId||"app-container",initialScene:e.initialScene||"index",scenesPath:e.scenesPath||"./assets/data/scenes.json",transitionDuration:e.transitionDuration||300,historyLength:e.historyLength||10,debugMode:e.debugMode||!1,onSceneLoad:e.onSceneLoad||null,onChoiceSelect:e.onChoiceSelect||null,animations:e.animations!==!1,persistState:e.persistState!==!1},this.state={currentScene:null,flags:new Set,history:[],variables:{}},this.init()}async init(){try{if(this.container=f.qs(`#${this.options.containerId}`),!this.container)throw new Error(`Container with ID "${this.options.containerId}" not found`);this.loadSettings(),await this.loadScenes(),this.loadSavedState(),this.state.currentScene?this.renderCurrentScene():this.navigateTo(this.options.initialScene),this.options.debugMode&&console.log("Epitome SPA Engine initialized",this)}catch(e){console.error("Failed to initialize Epitome SPA Engine:",e)}}loadSettings(){if(this.options.persistState)try{let e=u.get("epitome_settings");e&&(typeof e.animations=="boolean"&&(this.options.animations=e.animations),this.options.debugMode&&console.log("Loaded settings:",e));try{let n=localStorage.getItem("animations_enabled");n!==null&&e?.animations===void 0&&(this.options.animations=n==="true",this.setAnimations(this.options.animations),this.options.debugMode&&console.log("Migrated legacy animation setting:",this.options.animations))}catch(n){console.error("Failed to check legacy animation setting:",n)}}catch(e){console.error("Failed to load settings:",e)}}async loadScenes(){try{let e=await C(this.options.scenesPath);if(this.scenes=await e.json(),!this.scenes||Object.keys(this.scenes).length===0){console.error("No scenes found in scenes.json"),this.showErrorMessage("No scenes found. Please check the scenes.json file.");return}let n=[];if(Object.entries(this.scenes).forEach(([i,o])=>{w(o)||(n.push(i),console.warn(`Invalid scene found: ${i}`))}),n.length>0&&console.warn(`Found ${n.length} invalid scenes`),this.options.debugMode&&this.scenes){let i=A(this.scenes);i.length>0&&console.warn(`Found ${i.length} orphaned scenes that are not referenced from any other scene:`,i)}this.scenes&&!this.scenes[this.options.initialScene]&&(console.warn(`Initial scene "${this.options.initialScene}" not found. Using first available scene.`),this.options.initialScene=Object.keys(this.scenes)[0]),this.options.debugMode&&(console.log("Scenes loaded:",this.scenes),console.log("Available scene IDs:",Object.keys(this.scenes||{})),console.log("Using initial scene:",this.options.initialScene))}catch(e){throw console.error("Error loading scenes:",e),this.showErrorMessage("Failed to load scenes. Please check the console for details."),e}}showErrorMessage(e){if(this.container){let n=document.createElement("div");n.className="scene-error",n.style.color="red",n.style.padding="20px",n.style.textAlign="center",n.innerHTML=`<h2>Error</h2><p>${e}</p>`,this.container.innerHTML="",this.container.appendChild(n)}}loadSavedState(){if(this.options.persistState)try{let e=u.get("epitome_state");e&&(this.state.currentScene=e.currentScene,this.state.history=e.history||[],this.state.variables=e.variables||{},Array.isArray(e.flags)?this.state.flags=new Set(e.flags):e.flags instanceof Set?this.state.flags=e.flags:this.state.flags=new Set,this.options.debugMode&&console.log("Loaded saved state:",this.state))}catch(e){console.error("Failed to load saved state:",e),this.resetState()}}saveState(){if(this.options.persistState)try{let e={...this.state,flags:Array.from(this.state.flags)};u.set("epitome_state",e),this.options.debugMode&&console.log("State saved:",e)}catch(e){console.error("Failed to save state:",e)}}resetState(){this.state={currentScene:null,flags:new Set,history:[],variables:{}},this.options.persistState&&u.remove("epitome_state"),this.navigateTo(this.options.initialScene),this.options.debugMode&&console.log("State reset to defaults")}navigateTo(e,n=null){if(!this.scenes){console.error("Scenes not loaded");return}let i=this.scenes[e];if(!i){let o=`Scene not found: ${e}`;console.error(o);let r=Object.keys(this.scenes);if(r.length>0){console.warn(`Falling back to scene: ${r[0]}`),this.navigateTo(r[0]);return}else{this.showErrorMessage(o);return}}if(i.condition&&!this.evaluateCondition(i.condition)){console.log(`Condition not met for scene: ${e}`);return}if(i.set&&Array.isArray(i.set)&&i.set.forEach(o=>this.state.flags.add(o)),this.state.currentScene)for(this.state.history.push(this.state.currentScene);this.state.history.length>this.options.historyLength;)this.state.history.shift();this.state.currentScene=e,n&&(this.lastChoice=n),this.saveState(),this.renderCurrentScene(),typeof this.options.onSceneLoad=="function"&&this.options.onSceneLoad(i,n)}renderCurrentScene(){if(!this.state.currentScene||!this.scenes){console.error("Cannot render scene: No current scene or scenes not loaded");return}let e=this.state.currentScene,n=this.scenes[e];if(!n){console.error(`Cannot render scene: ${e} - not found`);return}let i=document.querySelectorAll("[data-scene-container]");if(i.length>0?this.renderCustomScene(n,i):this.renderDefaultScene(n),n.title){document.title=n.title;let o=document.querySelector('meta[name="description"]');if(o){let r=n.html||n.content||"",s=M(r);o.setAttribute("content",s)}}this.initNavigationElements()}renderDefaultScene(e){if(!this.container)return;let n=document.createElement("div");n.className="scene",this.options.animations&&n.classList.add("entering");let i=e.theme||(e.meta?e.meta.theme:null);if(i&&n.classList.add(`theme-${i}`),n.setAttribute("data-scene-id",e.id||""),e.title){let s=document.createElement("h1");s.className="scene-title",s.textContent=e.title,n.appendChild(s)}let o=document.createElement("div");o.className="scene-content",o.innerHTML=e.html||e.content||"",n.appendChild(o);let r=e.next||e.choices||[];if(r.length>0){let s=document.createElement("div");s.className="right-choices",r.forEach(a=>{if(a.condition&&!this.evaluateCondition(a.condition))return;let l=document.createElement("button");l.className="custom-choice";let c=a.id||a.target;c&&l.setAttribute("data-scene-id",c);let d=a.label||a.text||c||"Continue";l.textContent=d,f.on(l,"click",()=>{typeof this.options.onChoiceSelect=="function"&&this.options.onChoiceSelect(a),c&&this.navigateTo(c,a)}),s.appendChild(l)}),s.children.length>0&&n.appendChild(s)}this.options.animations?(this.container.classList.add("transitioning"),setTimeout(()=>{this.container&&(this.container.innerHTML="",this.container.appendChild(n),setTimeout(()=>{this.container&&(this.container.classList.remove("transitioning"),setTimeout(()=>{n.classList.remove("entering"),n.classList.add("active"),n.querySelectorAll(".scene-title, .scene-content").forEach(a=>{a.classList.add("active")})},50))},50))},this.options.transitionDuration)):(this.container.innerHTML="",this.container.appendChild(n),n.classList.add("active"),n.querySelectorAll(".scene-title, .scene-content").forEach(a=>{a.classList.add("active")}))}renderCustomScene(e,n){this.container&&(this.options.animations&&this.container.classList.add("transitioning"),n.forEach(i=>{switch(i.getAttribute("data-scene-container")){case"title":e.title&&(i.textContent=e.title,i.className="scene-title");break;case"content":i.innerHTML=e.html||e.content||"",i.className="scene-content";break;case"all":i.innerHTML="",i.className="scene",this.options.animations&&i.classList.add("entering");let s=e.theme||(e.meta?e.meta.theme:null);if(s&&i.classList.add(`theme-${s}`),e.title){let c=document.createElement("h1");c.className="scene-title",c.textContent=e.title,i.appendChild(c)}let a=document.createElement("div");a.className="scene-content",a.innerHTML=e.html||e.content||"",i.appendChild(a);break;case"choices":i.innerHTML="",i.className="right-choices";let l=e.next||e.choices||[];l.length>0&&l.forEach(c=>{if(c.condition&&!this.evaluateCondition(c.condition))return;let d=document.createElement("button");d.className="custom-choice";let m=c.id||c.target;m&&d.setAttribute("data-scene-id",m);let U=c.label||c.text||m||"Continue";d.textContent=U,f.on(d,"click",()=>{typeof this.options.onChoiceSelect=="function"&&this.options.onChoiceSelect(c),m&&this.navigateTo(m,c)}),i.appendChild(d)});break;default:this.renderDefaultScene(e);break}let r=e.id||"";i.setAttribute("data-current-scene",r)}),this.options.animations?setTimeout(()=>{this.container&&this.container.classList.remove("transitioning"),setTimeout(()=>{document.querySelectorAll(".scene.entering").forEach(r=>{r.classList.remove("entering"),r.classList.add("active")}),document.querySelectorAll(".scene-title, .scene-content").forEach(r=>{r.classList.add("active")})},50)},this.options.transitionDuration):(document.querySelectorAll(".scene").forEach(r=>{r.classList.remove("entering"),r.classList.add("active")}),document.querySelectorAll(".scene-title, .scene-content").forEach(r=>{r.classList.add("active")})))}initNavigationElements(){document.querySelectorAll("[data-scene-id]").forEach(n=>{if(n.hasAttribute("data-scene-initialized"))return;let i=n.getAttribute("data-scene-id");if(!i)return;let o=n.getAttribute("data-scene-condition");f.on(n,"click",r=>{if(r.preventDefault(),o&&!this.evaluateCondition(o)){console.log(`Condition not met for navigation to: ${i}`);return}this.navigateTo(i)}),n.setAttribute("data-scene-initialized","true")})}goBack(){if(this.state.history.length>0){let e=this.state.history.pop();e&&(this.state.currentScene=e,this.saveState(),this.renderCurrentScene())}else console.log("No previous scenes in history")}evaluateCondition(e){if(!e)return!0;try{let n={flags:this.state.flags,hasFlag:o=>this.state.flags.has(o),variables:this.state.variables,choice:this.lastChoice||{},history:this.state.history};return new Function(...Object.keys(n),`return ${e};`)(...Object.values(n))}catch(n){return console.error(`Error evaluating condition "${e}":`,n),!1}}setVariable(e,n){this.state.variables[e]=n,this.saveState()}getVariable(e){return this.state.variables[e]}hasFlag(e){return this.state.flags.has(e)}setFlag(e){this.state.flags.add(e),this.saveState()}clearFlag(e){this.state.flags.delete(e),this.saveState()}setAnimations(e){if(this.options.animations=e===!0,this.options.persistState)try{let n=u.get("epitome_settings")||{};n.animations=this.options.animations,u.set("epitome_settings",n),localStorage.getItem("animations_enabled")!==null&&(localStorage.removeItem("animations_enabled"),this.options.debugMode&&console.log("Removed legacy animations_enabled setting"))}catch(n){console.error("Failed to save animation settings:",n)}return this.options.animations}getAnimations(){return this.options.animations}};var Z={domUtils:p,storage:g,fetchWithTimeout:y,validateScene:v,extractSummary:b,findOrphanedScenes:x};L(Z);var ze=h;window.EpitomeSPA=h;document.addEventListener("DOMContentLoaded",()=>{if(document.querySelector('[data-no-auto-init="true"]')){console.log("Automatic initialization disabled");return}let e=document.getElementById("app-container");if(!e){console.warn('No container with ID "app-container" found. Skipping auto-initialization.');return}let n=e.getAttribute("data-debug-mode")==="true";console.log("Initializing Epitome SPA Engine...");try{let i=new h({containerId:"app-container",initialScene:"index",scenesPath:"./assets/data/scenes.json",debugMode:n});window.gameEngine=i}catch(i){console.error("Failed to initialize Epitome SPA Engine:",i)}});export{h as EpitomeSPA,F as arrayUtils,T as cookieUtils,H as copyToClipboard,W as createScene,E as createSceneId,I as dateUtils,k as debounce,ze as default,p as domUtils,b as extractSummary,y as fetchWithTimeout,x as findOrphanedScenes,K as findSceneReferences,$ as generateUUID,q as hasConditionalAccess,_ as hasReachableChoices,z as mergeSceneData,N as numberUtils,S as objectUtils,g as storage,R as stringUtils,D as throttle,P as urlUtils,v as validateScene,j as validation,O as wait};
//# sourceMappingURL=engine.js.map
