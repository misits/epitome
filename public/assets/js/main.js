var W=Object.defineProperty;var B=(e,t)=>{for(var n in t)W(e,n,{get:t[n],enumerable:!0})};var S={};B(S,{arrayUtils:()=>M,cookieUtils:()=>p,copyToClipboard:()=>D,createScene:()=>F,createSceneId:()=>g,dateUtils:()=>x,debounce:()=>y,domUtils:()=>w,extractSummary:()=>j,fetchWithTimeout:()=>T,findOrphanedScenes:()=>$,findSceneReferences:()=>q,generateUUID:()=>U,hasConditionalAccess:()=>O,hasReachableChoices:()=>P,mergeSceneData:()=>N,numberUtils:()=>L,objectUtils:()=>d,storage:()=>E,stringUtils:()=>A,throttle:()=>v,urlUtils:()=>C,validateScene:()=>k,validation:()=>I,wait:()=>b});var x={format:(e,t={},n="en-US")=>{let o=e instanceof Date?e:new Date(e);return new Intl.DateTimeFormat(n,t).format(o)},toYMD:e=>(e instanceof Date?e:new Date(e)).toISOString().split("T")[0],getRelativeTime:(e,t="en-US")=>{let n=e instanceof Date?e:new Date(e),o=new Intl.RelativeTimeFormat(t,{numeric:"auto"}),s=Math.floor((new Date-n)/1e3);if(s<60)return o.format(-s,"second");let r=Math.floor(s/60);if(r<60)return o.format(-r,"minute");let a=Math.floor(r/60);if(a<24)return o.format(-a,"hour");let m=Math.floor(a/24);if(m<30)return o.format(-m,"day");let f=Math.floor(m/30);if(f<12)return o.format(-f,"month");let J=Math.floor(f/12);return o.format(-J,"year")}};var y=(e,t=300,n=!1)=>{let o;return function(...i){let s=this,r=()=>{o=null,n||e.apply(s,i)},a=n&&!o;clearTimeout(o),o=setTimeout(r,t),a&&e.apply(s,i)}},v=(e,t=300)=>{let n,o,i;return function(...s){let r=this;n?(clearTimeout(o),o=setTimeout(()=>{Date.now()-i>=t&&(e.apply(r,s),i=Date.now())},t-(Date.now()-i))):(e.apply(r,s),i=Date.now(),n=!0)}},b=e=>new Promise(t=>setTimeout(t,e));var E={set:(e,t)=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(n){console.error("Error saving to localStorage:",n)}},get:(e,t=null)=>{try{let n=localStorage.getItem(e);return n?JSON.parse(n):t}catch(n){return console.error("Error reading from localStorage:",n),t}},remove:e=>{try{localStorage.removeItem(e)}catch(t){console.error("Error removing from localStorage:",t)}},clear:()=>{try{localStorage.clear()}catch(e){console.error("Error clearing localStorage:",e)}}};var C={getParams:(e=window.location.href)=>{let t={},n=document.createElement("a");n.href=e;let i=n.search.substring(1).split("&");for(let s=0;s<i.length;s++){if(i[s]==="")continue;let r=i[s].split("=");t[decodeURIComponent(r[0])]=decodeURIComponent(r[1]||"")}return t},buildUrl:(e,t={})=>{let n=new URL(e);return Object.keys(t).forEach(o=>{n.searchParams.append(o,t[o])}),n.toString()}};var w={qs:(e,t=document)=>{try{return t.querySelector(e)}catch(n){return console.error(`Invalid selector: ${e}`,n),null}},qsa:(e,t=document)=>{try{return[...t.querySelectorAll(e)]}catch(n){return console.error(`Invalid selector: ${e}`,n),[]}},on:(e,t,n,o={})=>e?(e.addEventListener(t,n,o),()=>{e.removeEventListener(t,n,o)}):()=>{}};var A={truncate:(e,t=100,n="...")=>!e||e.length<=t?e:e.substring(0,t-n.length)+n,capitalize:e=>e?e.charAt(0).toUpperCase()+e.slice(1):"",toCamelCase:e=>e.replace(/(?:^\w|[A-Z]|\b\w)/g,(t,n)=>n===0?t.toLowerCase():t.toUpperCase()).replace(/\s+/g,""),toKebabCase:e=>e.match(/[A-Z]{2,}(?=[A-Z][a-z]+[0-9]*|\b)|[A-Z]?[a-z]+[0-9]*|[A-Z]|[0-9]+/g)?.map(t=>t.toLowerCase()).join("-")||""};var M={chunk:(e,t=1)=>{let n=[];for(let o=0;o<e.length;o+=t)n.push(e.slice(o,o+t));return n},shuffle:e=>{let t=[...e],n=t.length,o,i;for(;n!==0;)i=Math.floor(Math.random()*n),n-=1,o=t[n],t[n]=t[i],t[i]=o;return t},randomItem:e=>e[Math.floor(Math.random()*e.length)],unique:e=>[...new Set(e)]};var p={get:e=>{let t=document.cookie.match(new RegExp(`(^|;\\s*)(${e})=([^;]*)`));return t?decodeURIComponent(t[3]):null},set:(e,t,n={})=>{let o={path:"/",...n};o.expires instanceof Date&&(o.expires=o.expires.toUTCString());let i=`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;for(let s in o){i+=`;${s}`;let r=o[s];r!==!0&&(i+=`=${r}`)}document.cookie=i},delete:(e,t={})=>{p.set(e,"",{...t,"max-age":-1})}};var d={deepClone:e=>JSON.parse(JSON.stringify(e)),deepMerge:(e,...t)=>{if(!t.length)return e;let n=t.shift();if(n===void 0)return e;if(typeof e=="object"&&typeof n=="object")for(let o in n)n[o]instanceof Object&&o in e?d.deepMerge(e[o],n[o]):Object.assign(e,{[o]:n[o]});return d.deepMerge(e,...t)},pick:(e,t)=>t.reduce((n,o)=>(o in e&&(n[o]=e[o]),n),{}),omit:(e,t)=>Object.keys(e).filter(n=>!t.includes(n)).reduce((n,o)=>(n[o]=e[o],n),{})};var L={formatCurrency:(e,t="USD",n="en-US")=>new Intl.NumberFormat(n,{style:"currency",currency:t}).format(e),clamp:(e,t,n)=>Math.min(Math.max(e,t),n),random:(e,t,n=!0)=>{let o=Math.random()*(t-e)+e;return n?Math.floor(o):o},round:(e,t=0)=>{let n=Math.pow(10,t);return Math.round(e*n)/n}};var I={isEmail:e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),isURL:e=>{try{return new URL(e),!0}catch{return!1}},isPhoneNumber:e=>/^\+?[\d\s()-]{10,}$/.test(e),isStrongPassword:e=>/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\da-zA-Z]).{8,}$/.test(e)};var T=(e,t={})=>{let{timeout:n=8e3,...o}=t;return Promise.race([fetch(e,o),new Promise((i,s)=>setTimeout(()=>s(new Error("Request timeout")),n))]).then(async i=>{if(!i.ok){let s=new Error(`HTTP error! status: ${i.status}`);s.status=i.status;try{s.data=await i.json()}catch{s.data=await i.text()}throw s}return i})};var U=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)}),D=e=>{if(navigator.clipboard)return navigator.clipboard.writeText(e);{let t=document.createElement("textarea");t.value=e,t.style.position="fixed",document.body.appendChild(t),t.focus(),t.select();try{return document.execCommand("copy"),document.body.removeChild(t),Promise.resolve()}catch(n){return document.body.removeChild(t),Promise.reject(n)}}};var k=e=>!(!e||typeof e!="object"||!e.id||e.html===void 0),j=(e,t=100)=>{if(!e||e==="")return"";try{let n=document.createElement("div");n.innerHTML=e;let o=n.textContent||n.innerText||"";return o=o.replace(/\s+/g," ").trim(),o.length>t?o.substring(0,t)+"...":o}catch(n){return console.error("Error extracting summary:",n),""}},g=e=>e?e.toLowerCase().replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim():"",$=e=>{if(!e||typeof e!="object")return[];let t=Object.keys(e),n=new Set;return t.forEach(o=>{let i=e[o];i.next&&Array.isArray(i.next)&&i.next.forEach(s=>{s.id&&n.add(s.id)})}),t.filter(o=>o!=="index"&&!n.has(o))},O=e=>e?e.condition?!0:e.next&&Array.isArray(e.next)?e.next.some(t=>!!t.condition):!1:!1,F=(e,t="",n="",o=[])=>({id:e||g(t),title:t,html:n,next:o}),N=(e,t)=>e?t?{...e,...t,next:t.next||e.next}:e:t,P=(e,t)=>!e||!e.next||!Array.isArray(e.next)?!1:e.next.some(n=>{if(!n.condition)return!0;try{let i={flags:t,hasFlag:r=>t.has(r)};return new Function(...Object.keys(i),`return ${n.condition};`)(...Object.values(i))}catch(o){return console.error(`Error evaluating condition "${n.condition}":`,o),!1}}),q=(e,t)=>!e||!t?[]:Object.keys(e).filter(n=>{let o=e[n];return!o.next||!Array.isArray(o.next)?!1:o.next.some(i=>i.id===t)});var l,c,R,z,H,_;function Z(e){l=e.domUtils,c=e.storage,R=e.fetchWithTimeout,z=e.validateScene,H=e.extractSummary,_=e.findOrphanedScenes}var u=class{constructor(t={}){this.options={containerId:t.containerId||"app-container",initialScene:t.initialScene||"index",scenesPath:t.scenesPath||"./assets/data/scenes.json",transitionDuration:t.transitionDuration||300,historyLength:t.historyLength||10,debugMode:t.debugMode||!1,onSceneLoad:t.onSceneLoad||null,onChoiceSelect:t.onChoiceSelect||null,animations:t.animations!==!1,persistState:t.persistState!==!1},this.state={currentScene:null,flags:new Set,history:[],variables:{}},this.container=null,this.scenes=null,this.init()}async init(){try{if(this.container=l.qs(`#${this.options.containerId}`),!this.container)throw new Error(`Container with ID "${this.options.containerId}" not found`);this.loadSettings(),await this.loadScenes(),this.loadSavedState(),this.state.currentScene?this.renderCurrentScene():this.navigateTo(this.options.initialScene),this.options.debugMode&&console.log("Epitome SPA Engine initialized",this)}catch(t){console.error("Failed to initialize Epitome SPA Engine:",t)}}loadSettings(){if(this.options.persistState)try{let t=c.get("epitome_settings");t&&(typeof t.animations=="boolean"&&(this.options.animations=t.animations),this.options.debugMode&&console.log("Loaded settings:",t));try{let n=localStorage.getItem("animations_enabled");n!==null&&t?.animations===void 0&&(this.options.animations=n==="true",this.setAnimations(this.options.animations),this.options.debugMode&&console.log("Migrated legacy animation setting:",this.options.animations))}catch(n){console.error("Failed to check legacy animation setting:",n)}}catch(t){console.error("Failed to load settings:",t)}}async loadScenes(){try{let t=await R(this.options.scenesPath);if(this.scenes=await t.json(),Object.keys(this.scenes).length===0){console.error("No scenes found in scenes.json"),this.showErrorMessage("No scenes found. Please check the scenes.json file.");return}let n=[];if(Object.entries(this.scenes).forEach(([o,i])=>{z(i)||(n.push(o),console.warn(`Invalid scene found: ${o}`))}),n.length>0&&console.warn(`Found ${n.length} invalid scenes`),this.options.debugMode){let o=_(this.scenes);o.length>0&&console.warn(`Found ${o.length} orphaned scenes that are not referenced from any other scene:`,o)}this.scenes[this.options.initialScene]||(console.warn(`Initial scene "${this.options.initialScene}" not found. Using first available scene.`),this.options.initialScene=Object.keys(this.scenes)[0]),this.options.debugMode&&(console.log("Scenes loaded:",this.scenes),console.log("Available scene IDs:",Object.keys(this.scenes)),console.log("Using initial scene:",this.options.initialScene))}catch(t){throw console.error("Error loading scenes:",t),this.showErrorMessage("Failed to load scenes. Please check the console for details."),t}}showErrorMessage(t){if(this.container){let n=document.createElement("div");n.className="scene-error",n.style.color="red",n.style.padding="20px",n.style.textAlign="center",n.innerHTML=`<h2>Error</h2><p>${t}</p>`,this.container.innerHTML="",this.container.appendChild(n)}}loadSavedState(){if(this.options.persistState)try{let t=c.get("epitome_state");t&&(this.state.currentScene=t.currentScene,this.state.history=t.history||[],this.state.variables=t.variables||{},this.state.flags=new Set(t.flags||[]),this.options.debugMode&&console.log("Loaded saved state:",this.state))}catch(t){console.error("Failed to load saved state:",t),this.resetState()}}saveState(){if(this.options.persistState)try{let t={...this.state,flags:Array.from(this.state.flags)};c.set("epitome_state",t),this.options.debugMode&&console.log("State saved:",t)}catch(t){console.error("Failed to save state:",t)}}resetState(){this.state={currentScene:null,flags:new Set,history:[],variables:{}},this.options.persistState&&c.remove("epitome_state"),this.navigateTo(this.options.initialScene),this.options.debugMode&&console.log("State reset to defaults")}navigateTo(t,n=null){let o=this.scenes[t];if(!o){let i=`Scene not found: ${t}`;console.error(i);let s=Object.keys(this.scenes);if(s.length>0){console.warn(`Falling back to scene: ${s[0]}`),this.navigateTo(s[0]);return}else{this.showErrorMessage(i);return}}if(o.condition&&!this.evaluateCondition(o.condition)){console.log(`Condition not met for scene: ${t}`);return}if(o.set&&Array.isArray(o.set)&&o.set.forEach(i=>this.state.flags.add(i)),this.state.currentScene)for(this.state.history.push(this.state.currentScene);this.state.history.length>this.options.historyLength;)this.state.history.shift();this.state.currentScene=t,n&&(this.state.lastChoice=n),this.saveState(),this.renderCurrentScene(),typeof this.options.onSceneLoad=="function"&&this.options.onSceneLoad(o,n)}renderCurrentScene(){let t=this.state.currentScene,n=this.scenes[t];if(!n){console.error(`Cannot render scene: ${t} - not found`);return}let o=document.querySelectorAll("[data-scene-container]");if(o.length>0?this.renderCustomScene(n,o):this.renderDefaultScene(n),n.title){document.title=n.title;let i=document.querySelector('meta[name="description"]');if(i){let s=H(n.html);i.setAttribute("content",s)}}this.initNavigationElements()}renderDefaultScene(t){let n=document.createElement("div");if(n.className="scene",this.options.animations&&n.classList.add("entering"),t.theme&&n.classList.add(`theme-${t.theme}`),n.setAttribute("data-scene-id",t.id),t.title){let i=document.createElement("h1");i.className="scene-title",i.textContent=t.title,n.appendChild(i)}let o=document.createElement("div");if(o.className="scene-content",o.innerHTML=t.html||"",n.appendChild(o),t.next&&t.next.length>0){let i=document.createElement("div");i.className="right-choices",t.next.forEach(s=>{if(s.condition&&!this.evaluateCondition(s.condition))return;let r=document.createElement("button");r.className="custom-choice",r.textContent=s.label||s.id||"Continue",l.on(r,"click",()=>{typeof this.options.onChoiceSelect=="function"&&this.options.onChoiceSelect(s),this.navigateTo(s.id,s)}),i.appendChild(r)}),i.children.length>0&&n.appendChild(i)}this.options.animations?(this.container.classList.add("transitioning"),setTimeout(()=>{this.container.innerHTML="",this.container.appendChild(n),setTimeout(()=>{this.container.classList.remove("transitioning"),setTimeout(()=>{n.classList.remove("entering"),n.classList.add("active"),n.querySelectorAll(".scene-title, .scene-content").forEach(s=>{s.classList.add("active")})},50)},50)},this.options.transitionDuration)):(this.container.innerHTML="",this.container.appendChild(n),n.classList.add("active"),n.querySelectorAll(".scene-title, .scene-content").forEach(s=>{s.classList.add("active")}))}renderCustomScene(t,n){this.options.animations&&this.container.classList.add("transitioning"),n.forEach(o=>{switch(o.getAttribute("data-scene-container")){case"title":t.title&&(o.textContent=t.title,o.className="scene-title");break;case"content":o.innerHTML=t.html||"",o.className="scene-content";break;case"all":if(o.innerHTML="",o.className="scene",this.options.animations&&o.classList.add("entering"),t.theme&&o.classList.add(`theme-${t.theme}`),t.title){let r=document.createElement("h1");r.className="scene-title",r.textContent=t.title,o.appendChild(r)}let s=document.createElement("div");s.className="scene-content",s.innerHTML=t.html||"",o.appendChild(s);break;case"choices":o.innerHTML="",o.className="right-choices",t.next&&t.next.length>0&&t.next.forEach(r=>{if(r.condition&&!this.evaluateCondition(r.condition))return;let a=document.createElement("button");a.className="custom-choice",a.setAttribute("data-scene-id",r.id),a.textContent=r.label||r.id||"Continue",l.on(a,"click",()=>{typeof this.options.onChoiceSelect=="function"&&this.options.onChoiceSelect(r),this.navigateTo(r.id,r)}),o.appendChild(a)});break;default:this.renderDefaultScene(t);break}o.setAttribute("data-current-scene",t.id)}),this.options.animations?setTimeout(()=>{this.container.classList.remove("transitioning"),setTimeout(()=>{document.querySelectorAll(".scene.entering").forEach(s=>{s.classList.remove("entering"),s.classList.add("active")}),document.querySelectorAll(".scene-title, .scene-content").forEach(s=>{s.classList.add("active")})},50)},this.options.transitionDuration):(document.querySelectorAll(".scene").forEach(s=>{s.classList.remove("entering"),s.classList.add("active")}),document.querySelectorAll(".scene-title, .scene-content").forEach(s=>{s.classList.add("active")}))}initNavigationElements(){document.querySelectorAll("[data-scene-id]").forEach(n=>{if(n.hasAttribute("data-scene-initialized"))return;let o=n.getAttribute("data-scene-id"),i=n.getAttribute("data-scene-condition");l.on(n,"click",s=>{if(s.preventDefault(),i&&!this.evaluateCondition(i)){console.log(`Condition not met for navigation to: ${o}`);return}this.navigateTo(o)}),n.setAttribute("data-scene-initialized","true")})}goBack(){if(this.state.history.length>0){let t=this.state.history.pop();this.state.currentScene=t,this.saveState(),this.renderCurrentScene()}else console.log("No previous scenes in history")}evaluateCondition(t){if(!t)return!0;try{let n={flags:this.state.flags,hasFlag:i=>this.state.flags.has(i),variables:this.state.variables,choice:this.state.lastChoice||{},history:this.state.history};return new Function(...Object.keys(n),`return ${t};`)(...Object.values(n))}catch(n){return console.error(`Error evaluating condition "${t}":`,n),!1}}setVariable(t,n){this.state.variables[t]=n,this.saveState()}getVariable(t){return this.state.variables[t]}hasFlag(t){return this.state.flags.has(t)}setFlag(t){this.state.flags.add(t),this.saveState()}clearFlag(t){this.state.flags.delete(t),this.saveState()}setAnimations(t){if(this.options.animations=t===!0,this.options.persistState)try{let n=c.get("epitome_settings")||{};n.animations=this.options.animations,c.set("epitome_settings",n),localStorage.getItem("animations_enabled")!==null&&(localStorage.removeItem("animations_enabled"),this.options.debugMode&&console.log("Removed legacy animations_enabled setting"))}catch(n){console.error("Failed to save animation settings:",n)}return this.options.animations}getAnimations(){return this.options.animations}},h=u;window.EpitomeSPA=u;Z(S);var At=h;window.EpitomeSPA=h;document.addEventListener("DOMContentLoaded",()=>{if(document.querySelector('[data-no-auto-init="true"]')){console.log("Automatic initialization disabled");return}let t=document.getElementById("app-container");if(!t){console.warn('No container with ID "app-container" found. Skipping auto-initialization.');return}let n=t.getAttribute("data-debug-mode")==="true";console.log("Initializing Epitome SPA Engine...");try{let o=new h({containerId:"app-container",initialScene:"index",scenesPath:"./assets/data/scenes.json",debugMode:n});window.gameEngine=o}catch(o){console.error("Failed to initialize Epitome SPA Engine:",o)}});export{h as EpitomeSPA,M as arrayUtils,p as cookieUtils,D as copyToClipboard,F as createScene,g as createSceneId,x as dateUtils,y as debounce,At as default,w as domUtils,j as extractSummary,T as fetchWithTimeout,$ as findOrphanedScenes,q as findSceneReferences,U as generateUUID,O as hasConditionalAccess,P as hasReachableChoices,N as mergeSceneData,L as numberUtils,d as objectUtils,E as storage,A as stringUtils,v as throttle,C as urlUtils,k as validateScene,I as validation,b as wait};
